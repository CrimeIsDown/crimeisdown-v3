{{#if (eq this.hasAccess undefined)}}
<p {{did-insert this.setupSearch}}>Logging in...</p>
{{/if}}
<div class="search-panel row {{if (eq this.hasAccess undefined) "d-none" ""}}">
  <div class="search-panel__filters col-md-3">
    {{#if (eq this.hasAccess false)}}
    <div class="alert alert-danger">
      {{#if this.session.isAuthenticated}}
      <p>You are not at a high enough membership tier. Please upgrade your membership on Patreon to the Sergeant tier or above to access.</p>
      {{else}}
      <p>You are currently using a demo version with old transmissions. To search the latest scanner traffic, become a patron of at least $5/mo and then <a href="https://api.crimeisdown.com/auth/redirect" referrerpolicy="unsafe-url">login</a>.</p>
      <p class="mt-2"><a href="https://www.patreon.com/bePatron?u=4805116" referrerpolicy="unsafe-url" class="ptrn-button"><img src="/img/become-a-patron.png" alt="Become a Patron!"></a></p>
      {{/if}}
    </div>
    {{/if}}
    <div id="auto-refresh" class="mb-2">
      <div class="input-group">
        <span class="input-group-text" id="refresh-interval-val">
        Auto Refresh:
        {{#if (eq this.autoRefreshInterval "0")}}
          Off
        {{else}}
          {{this.autoRefreshInterval}}s
        {{/if}}
        </span>
        {{#if this.hasAccess}}
        <Input @type="range" class="form-control form-range" min="0" max="120" step="10" id="refresh-interval" @value={{this.autoRefreshInterval}} {{on "change" this.restartAutoRefresh}} />
        {{else}}
        <Input @type="range" class="form-control form-range disabled" min="0" max="120" step="10" id="refresh-interval" @value={{this.autoRefreshInterval}} disabled />
        {{/if}}
      </div>
    </div>
    <div id="waveform-setting" class="mb-2">
      <div class="form-check form-switch">
        <Input class="form-check-input" @type="checkbox" role="switch" id="waveform-toggle" @checked={{this.useMediaPlayerComponent}} />
        <label class="form-check-label" for="waveform-toggle">Show waveform when playing audio</label>
      </div>
    </div>
    <div class="accordion">
      <h2 id="filtersHeadingAccordion" data-bs-toggle="collapse" data-bs-target="#filters" aria-expanded="true" aria-controls="filters">
        <button class="accordion-button" type="button" >
          Filters
        </button>
      </h2>
    </div>
    <h2 id="filtersHeading">Filters</h2>
    <div id="filters" class="collapse">
      <div id="clear-refinements"></div>
      <div class="accordion accordion-flush" id="filterOptionsAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="dept-heading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dept-collapse" aria-expanded="false" aria-controls="dept-collapse">
                  Departments
                </button>
              </h2>
              <div id="dept-collapse" class="accordion-collapse collapse show" aria-labelledby="dept-heading">
                <div id="dept-menu" class="accordion-body"></div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="tg-heading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tg-collapse" aria-expanded="false" aria-controls="tg-collapse">
                  Talkgroups
                </button>
              </h2>
              <div id="tg-collapse" class="accordion-collapse collapse show" aria-labelledby="tg-heading">
                <div id="tg-menu" class="accordion-body"></div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="units-heading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#units-collapse" aria-expanded="false" aria-controls="units-collapse">
                  Units
                </button>
              </h2>
              <div id="units-collapse" class="accordion-collapse collapse show" aria-labelledby="units-heading">
                <div id="units-menu" class="accordion-body"></div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="radios-heading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#radios-collapse" aria-expanded="false" aria-controls="radios-collapse">
                  Radio IDs
                </button>
              </h2>
              <div id="radios-collapse" class="accordion-collapse collapse" aria-labelledby="radios-heading">
                <div id="radios-menu" class="accordion-body"></div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="srclist-heading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#srclist-collapse" aria-expanded="false" aria-controls="srclist-collapse">
                  Sources
                </button>
              </h2>
              <div id="srclist-collapse" class="accordion-collapse collapse" aria-labelledby="srclist-heading">
                <div id="srclist-menu" class="accordion-body"></div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="calltime-heading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#time-input-collapse" aria-expanded="false" aria-controls="time-input-collapse">
                  Call Time
                </button>
              </h2>
              <div id="time-input-collapse" class="accordion-collapse collapse show" aria-labelledby="calltime-heading">
                <div id="time-input" class="accordion-body">
                  <div class="col">
                    <label for="minStartTime">From Time</label>
                    <div class="input-group date">
                      <EmberFlatpickr name="minStartTime" @id="minStartTime" @allowInput={{true}} class="form-control" @defaultDate={{this.flatpickrOptions.minDefaultDate}} @enableTime={{this.flatpickrOptions.enableTime}} @dateFormat={{this.flatpickrOptions.dateFormat}} @date={{this.minStartTime}} @onChange={{null}} @onClose={{this.setStartTimeRange}} @altInput={{this.flatpickrOptions.altInput}} @altFormat={{this.flatpickrOptions.altFormat}} />
                      <span class="input-group-text"><FaIcon @icon="calendar" /></span>
                    </div>
                  </div>
                  <div class="col">
                    <label for="maxStartTime">To Time</label>
                    <div class="input-group date">
                      <EmberFlatpickr name="maxStartTime" @id="maxStartTime" @allowInput={{true}} class="form-control" @defaultDate={{this.flatpickrOptions.maxDefaultDate}} @enableTime={{this.flatpickrOptions.enableTime}} @dateFormat={{this.flatpickrOptions.dateFormat}} @date={{this.maxStartTime}} @onChange={{null}} @onClose={{this.setStartTimeRange}} @altInput={{this.flatpickrOptions.altInput}} @altFormat={{this.flatpickrOptions.altFormat}} />
                      <span class="input-group-text"><FaIcon @icon="calendar" /></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
    </div>
  </div>
  <div class="search-panel__results col">
    {{#if (eq this.hasAccess false)}}
    <h1 class="display-5">Call Transcript Search Demo</h1>
    {{else}}
    <h1 class="display-5 sr-only">Call Transcript Search</h1>
    {{/if}}
    <div class="row mb-1">
      <div id="searchbox" class="col mb-2"></div>
      <div id="sort-by" class="col-md-3 mb-2"></div>
      <div id="hits-per-page" class="col-md-2 mb-2"></div>
    </div>
    <div id="current-refinements"></div>
    <div id="stats" class="mb-1"></div>
    <div id="hits" class="ais-Hits">
      <ol class="ais-Hits-list">
        {{#each this.hits key="id" as |hit|}}
        <li id="hit-{{hit.id}}" class="ais-Hits-item{{if (eq hit.id this.selectedHit) " selected" ""}}" {{did-insert (fn this.scrollToHit this.selectedHit)}}>
          <div class="row">
            <div class="col">
              <h4 class="fs-5" title="{{hit.talkgroup_description}}">
                <a href="{{hit.contextUrl}}" {{on "click" (fn this.getContext hit)}}>{{hit.talkgroup_tag}}</a>
              </h4>
              <h5 class="fs-6">
                {{hit.talkgroup_group}}
              </h5>
              <p>
                <strong>
                  <a href="{{hit.permalink}}">{{hit.start_time_string}}</a> ({{hit.relative_time}})
                </strong>
                {{hit.time_warning}}
              </p>
              <p>
                <span class="badge text-bg-light me-1">
                  Duration: {{hit.call_length}}s
                </span>
                <span class="badge text-bg-info me-1">
                  TG {{hit.talkgroup}}
                </span>
                <span class="badge text-bg-info me-1">
                  {{hit.talkgroup_group_tag}}
                </span>
                <span
                  class="badge {{if (eq hit.audio_type "digital") "text-bg-primary" "text-bg-secondary"}} me-1"
                >
                  {{hit.audio_type}}
                </span>
                {{#if hit.encrypted}}
                <span class="badge text-bg-danger me-1" data-bs-toggle="tooltip" title="From an official Broadcastify.com stream of an encrypted channel">
                  Encrypted / Delayed 30mins
                </span>
                {{/if}}
                <button
                  class="badge text-bg-light btn btn-sm btn-light"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#metadata-{{hit.id}}"
                  aria-expanded="true"
                  aria-controls="metadata-{{hit.id}}"
                >
                  Open Raw Metadata
                </button>
              </p>
              <div class="collapse mt-3 mb-3" id="metadata-{{hit.id}}">
                <pre>{{hit.raw_metadata}}</pre>
              </div>
              {{#unless this.useMediaPlayerComponent}}
              <audio
                id="call-audio-{{hit.id}}"
                class="call-audio"
                src="{{hit.raw_audio_url}}"
                controls
                preload="none"
              ></audio>
              {{/unless}}
              <p>
                {{!-- template-lint-disable no-triple-curlies --}}
                {{{hit._highlightResult.transcript.value}}}
              </p>
            </div>
            {{#if this.useMediaPlayerComponent}}
            <div class="col-lg-5 media-player-container">
              <MediaPlayer @src="{{hit.raw_audio_url}}" @type="audio/mpeg" @idSuffix="-{{hit.id}}" @hideZoom="true" @preload="none" />
            </div>
            {{/if}}
          </div>
        </li>
        {{/each}}
      </ol>
    </div>
    <div id="pagination" class="mt-3"></div>
  </div>
</div>
